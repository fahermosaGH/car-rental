<div class="page">

  <div class="header">
    <div>
      <h1>Incidentes</h1>
      <p class="sub">
        Gestioná reasignación manual de unidades ante problemas en reservas.
      </p>
    </div>
  </div>

  <div class="card" *ngIf="rows.length > 0">
    <table class="table">
      <thead>
        <tr>
          <th>#</th>
          <th>Reserva</th>
          <th>Descripción</th>
          <th>Unidad rota</th>
          <th>Unidad reemplazo</th>
          <th>Estado</th>
          <th>Reasignación</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let it of rows">

          <td>#{{ it.id }}</td>

          <td>
            <strong>#{{ it.reservation?.id }}</strong>
            <div class="muted">
              Retiro: {{ it.reservation?.pickupLocationId }} ·
              {{ it.reservation?.startAt }} → {{ it.reservation?.endAt }}
            </div>
          </td>

          <td class="desc">
            {{ it.description }}
          </td>

          <td>
            <div *ngIf="it.brokenUnit; else noBroken">
              <strong>{{ it.brokenUnit.plate }}</strong>
              <div class="muted">{{ it.brokenUnit.vehicleName }}</div>
              <div class="muted">Estado unidad: {{ it.brokenUnit.status }}</div>
            </div>
            <ng-template #noBroken>-</ng-template>
          </td>

          <td>
            <div *ngIf="it.replacementUnit; else noRepl">
              <strong>{{ it.replacementUnit.plate }}</strong>
              <div class="muted">{{ it.replacementUnit.vehicleName }}</div>
            </div>
            <ng-template #noRepl>-</ng-template>
          </td>

          <td>
            <strong>{{ it.status }}</strong>
            <div class="muted" *ngIf="it.resolvedAt">
              Resuelto: {{ fmtDateTime(it.resolvedAt) }}
            </div>
          </td>

          <td>
            <div *ngIf="isResolved(it)">
              <span class="badge-ok">Ya reasignado</span>
            </div>

            <div *ngIf="!isResolved(it)">
              <button class="btn btn-secondary"
                      (click)="cargarUnidades(it.id)"
                      [disabled]="loadingUnits[it.id]">
                {{ loadingUnits[it.id] ? 'Buscando...' : 'Ver disponibles' }}
              </button>

              <div class="reassign-box" *ngIf="unitsMap[it.id]">

                <div *ngIf="unitsMap[it.id].length > 0">

                  <select class="form-select"
                          [(ngModel)]="selectedUnit[it.id]">
                    <option [ngValue]="null" disabled>
                      Seleccionar unidad disponible
                    </option>

                    <option *ngFor="let u of unitsMap[it.id]"
                            [ngValue]="u.id">
                      {{ u.plate }} · {{ u.vehicleName }}
                    </option>
                  </select>

                  <button class="btn btn-primary"
                          (click)="reasignar(it.id)">
                    Confirmar
                  </button>

                </div>

                <div *ngIf="unitsMap[it.id].length === 0"
                     class="empty-msg">
                  No hay unidades disponibles en esta sucursal para esas fechas.
                </div>

              </div>
            </div>
          </td>

        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="rows.length === 0" class="state">
    No hay incidentes registrados.
  </div>

</div>