<div class="page">
  <div class="toolbar">
    <div>
      <h1>Incidentes</h1>
      <p class="sub">
        Reportes de problemas durante una reserva. Gestioná reasignación y resolución.
      </p>
    </div>

    <div class="toolbar-right">
      <label class="muted">
        Estado:
        <select class="select" [(ngModel)]="statusFilter" (change)="cargar()">
          <option value="open">Abiertos</option>
          <option value="resolved">Resueltos</option>
          <option value="">Todos</option>
        </select>
      </label>

      <button class="btn" (click)="cargar()">Refrescar</button>
    </div>
  </div>

  <div *ngIf="loading" class="state">Cargando incidentes...</div>
  <div *ngIf="!loading && errorMsg" class="state error">{{ errorMsg }}</div>

  <div *ngIf="!loading && !errorMsg && rows.length === 0" class="state">
    No hay incidentes para mostrar.
  </div>

  <div *ngIf="!loading && rows.length > 0" class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>#</th>
          <th>Reserva</th>
          <th>Vehículo</th>
          <th>Fechas</th>
          <th>Descripción</th>
          <th>Unidad dañada</th>
          <th>Estado</th>
          <th style="width: 360px;">Acciones</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let it of rows">
          <td>#{{ it.id }}</td>

          <td>
            <ng-container *ngIf="it.reservation?.id; else noResId">
              #{{ it.reservation?.id }}
            </ng-container>
            <ng-template #noResId>—</ng-template>
          </td>

          <td>{{ it.reservation?.vehicleName || '—' }}</td>

          <td>
            <div class="dates" *ngIf="it.reservation?.startAt && it.reservation?.endAt; else noDates">
              <span>{{ it.reservation?.startAt | date:'shortDate' }}</span>
              <span>→</span>
              <span>{{ it.reservation?.endAt | date:'shortDate' }}</span>
            </div>
            <ng-template #noDates>—</ng-template>
          </td>

          <td class="desc">{{ it.description }}</td>

          <td>
            <span *ngIf="it.damagedUnit?.plate; else noUnit">
              {{ it.damagedUnit?.plate }} ({{ it.damagedUnit?.status }})
            </span>
            <ng-template #noUnit>—</ng-template>
          </td>

          <td>
            <span [class]="badgeClass(it.status)">{{ it.status }}</span>
          </td>

          <td>
            <div class="actions">
              <button
                class="btn btn-danger"
                (click)="resolver(it)"
                [disabled]="it.status !== 'open'"
              >
                Resolver
              </button>

              <div class="actions-row">
                <input
                  class="input"
                  type="number"
                  placeholder="newUnitId"
                  [(ngModel)]="newUnitIdInput[it.id]"
                  [disabled]="it.status !== 'open' || reassigningId === it.id"
                />

                <label class="checkbox">
                  <input
                    type="checkbox"
                    [(ngModel)]="markMaintenance[it.id]"
                    [disabled]="it.status !== 'open' || reassigningId === it.id"
                  />
                  Daño → maintenance
                </label>

                <button
                  class="btn btn-primary"
                  (click)="reasignar(it)"
                  [disabled]="it.status !== 'open' || reassigningId === it.id"
                >
                  {{ reassigningId === it.id ? 'Reasignando...' : 'Reasignar' }}
                </button>
              </div>

              <div class="tip">
                Tip: buscá el <b>ID</b> de la unidad en “Unidades” y pegalo en <b>newUnitId</b>.
              </div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>