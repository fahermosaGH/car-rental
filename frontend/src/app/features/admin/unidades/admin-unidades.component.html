<div class="head">
  <div>
    <h2>Unidades (Patentes)</h2>
    <p class="sub">
      Cada unidad representa un auto físico con patente. El stock se deriva automáticamente de las unidades
      en estado <b>Disponible</b>.
    </p>
  </div>
  <button class="btn" type="button" (click)="load()" [disabled]="loading || creating">Recargar</button>
</div>

<div *ngIf="error" class="alert">
  No se pudieron cargar las unidades.
  <button class="btn-small" type="button" (click)="bootstrap()">Reintentar</button>
</div>

<!-- CREATE -->
<div class="card">
  <div class="card-title">Nueva unidad</div>

  <div class="form-row">
    <div class="field">
      <label>Patente</label>
      <input class="input" type="text" [(ngModel)]="plate" placeholder="Ej: AA123BB" />
    </div>

    <div class="field">
      <label>Vehículo</label>
      <select class="select" [(ngModel)]="vehicleId">
        <option [ngValue]="0">Seleccionar...</option>
        <option *ngFor="let v of vehicles" [ngValue]="v.id">
          {{ v.brand }} {{ v.model }} ({{ v.year ?? '-' }})
        </option>
      </select>
    </div>

    <div class="field">
      <label>Sucursal</label>
      <select class="select" [(ngModel)]="locationId">
        <option [ngValue]="0">Seleccionar...</option>
        <option *ngFor="let l of locations" [ngValue]="l.id">
          {{ l.name }} ({{ l.city ?? '-' }})
        </option>
      </select>
    </div>

    <div class="field">
      <label>Estado</label>
      <select class="select" [(ngModel)]="status">
        <option *ngFor="let s of statuses" [ngValue]="s.value">{{ s.label }}</option>
      </select>
    </div>

    <div class="field actions">
      <label>&nbsp;</label>
      <button class="btn" type="button" (click)="create()" [disabled]="creating">
        {{ creating ? 'Creando...' : 'Crear unidad' }}
      </button>
    </div>
  </div>

  <div *ngIf="createError" class="form-error">{{ createError }}</div>
</div>

<!-- FILTERS -->
<div class="filters card">
  <div class="card-title">Filtros</div>

  <div class="form-row">
    <div class="field">
      <label>Vehículo</label>
      <select class="select" [(ngModel)]="fVehicleId" (change)="load()">
        <option [ngValue]="0">Todos</option>
        <option *ngFor="let v of vehicles" [ngValue]="v.id">
          {{ v.brand }} {{ v.model }} ({{ v.year ?? '-' }})
        </option>
      </select>
    </div>

    <div class="field">
      <label>Sucursal</label>
      <select class="select" [(ngModel)]="fLocationId" (change)="load()">
        <option [ngValue]="0">Todas</option>
        <option *ngFor="let l of locations" [ngValue]="l.id">
          {{ l.name }} ({{ l.city ?? '-' }})
        </option>
      </select>
    </div>

    <div class="field">
      <label>Estado</label>
      <select class="select" [(ngModel)]="fStatus" (change)="load()">
        <option [ngValue]="''">Todos</option>
        <option *ngFor="let s of statuses" [ngValue]="s.value">{{ s.label }}</option>
      </select>
    </div>

    <div class="field actions">
      <label>&nbsp;</label>
      <button class="btn-small" type="button" (click)="clearFilters()" [disabled]="loading">Limpiar</button>
    </div>
  </div>
</div>

<!-- TABLE -->
<div class="card" *ngIf="!loading && rows.length === 0 && !error">No hay unidades cargadas.</div>

<div class="table-wrap" *ngIf="rows.length > 0">
  <table class="table">
    <thead>
      <tr>
        <th>Patente</th>
        <th>Estado</th>
        <th>Sucursal</th>
        <th>Vehículo</th>
        <th class="num">Acciones</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let r of rows">
        <td>
          <input
            class="input small"
            [(ngModel)]="edit[r.id].plate"
            [ngModelOptions]="{ standalone: true }"
          />
        </td>

        <td>
          <select
            class="select small"
            [(ngModel)]="edit[r.id].status"
            [ngModelOptions]="{ standalone: true }"
          >
            <option *ngFor="let s of statuses" [ngValue]="s.value">{{ s.label }}</option>
          </select>
        </td>

        <td>
          <div class="strong">{{ r.location?.name }}</div>
          <div class="muted">{{ r.location?.city ?? '-' }}</div>
        </td>

        <td>
          <div class="strong">{{ r.vehicle?.brand ?? '' }} {{ r.vehicle?.model ?? '' }}</div>
          <div class="muted">ID: {{ r.vehicle?.id }} · {{ r.vehicle?.year ?? '-' }}</div>
        </td>

        <td class="num">
          <button class="btn-small" type="button" (click)="saveRow(r)" [disabled]="updating[r.id]">
            {{ updating[r.id] ? 'Guardando...' : 'Guardar' }}
          </button>
          <button class="btn-small danger" type="button" (click)="removeRow(r)" [disabled]="deleting[r.id]">
            {{ deleting[r.id] ? 'Eliminando...' : 'Eliminar' }}
          </button>
        </td>
      </tr>
    </tbody>
  </table>
</div>