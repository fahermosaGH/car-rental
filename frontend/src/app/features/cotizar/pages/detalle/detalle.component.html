<section class="detalle-page" *ngIf="vehiculo; else loadingTpl">
  <!-- Barra superior: volver + badge de disponibilidad -->
  <header class="detalle-header">
    <button class="btn-back" routerLink="/cotizar/resultados">
      ‚Üê Volver a resultados
    </button>

    <div class="header-right">
      <span *ngIf="checking" class="chip chip-warning">
        ‚è≥ Verificando disponibilidad...
      </span>

      <span
        *ngIf="!checking && unitsAvailable !== undefined"
        class="chip"
        [class.chip-ok]="unitsAvailable > 0"
        [class.chip-error]="unitsAvailable <= 0"
      >
        {{ unitsAvailable > 0 ? 'Disponible' : 'Sin stock' }}
      </span>
    </div>
  </header>

  <!-- Layout principal: info a la izquierda, resumen a la derecha -->
  <div class="detalle-layout">
    <!-- Panel principal del veh√≠culo -->
    <article class="panel panel-main">
      <div class="hero-image">
        <img [src]="vehiculo!.img" [alt]="vehiculo!.name" />
      </div>

      <div class="main-body">
        <div class="title-row">
          <div>
            <h1>{{ vehiculo!.name }}</h1>
            <p class="categoria">
              {{ vehiculo!.category || 'Sin categor√≠a' }}
            </p>
          </div>
        </div>

        <div class="meta-row">
          <span *ngIf="vehiculo!.transmission">
            ‚öôÔ∏è {{ vehiculo!.transmission | titlecase }}
          </span>
          <span *ngIf="vehiculo!.fuel">
            ‚õΩ {{ vehiculo!.fuel }}
          </span>
        </div>

        <section class="block">
          <h2>Descripci√≥n</h2>
          <p>
            {{ vehiculo!.description || 'Veh√≠culo c√≥modo y seguro para tu pr√≥ximo viaje.' }}
          </p>
        </section>

        <section class="block block-tarifa">
          <div class="tarifa-header">
            <div>
              <span class="label">Tarifa diaria</span>
              <div class="tarifa-valor">
                {{ vehiculo!.dailyRate | currency:'ARS' }}
              </div>
            </div>
            <div class="tarifa-info">
              <span class="dias">
                {{ dias }} {{ dias === 1 ? 'd√≠a' : 'd√≠as' }}
              </span>
            </div>
          </div>
        </section>

        <!-- SEGMENTO NUEVO: seguros estilo Hertz -->
        <section class="block">
          <div class="block-header">
            <h2>Seguros</h2>
            <span class="block-tag">Por reserva</span>
          </div>
          <p class="block-subtitle">
            Eleg√≠ una cobertura opcional para reducir la franquicia por da√±os en tu alquiler.
          </p>

          <div class="extras-grid extras-seguros">
            <label
              class="extra-item extra-seguro"
              *ngFor="let s of seguros"
              [class.extra-seguro--selected]="selectedSeguroId === s.id"
            >
              <input
                type="radio"
                name="seguro"
                [value]="s.id"
                [(ngModel)]="selectedSeguroId"
                (change)="actualizarTotal()"
              />
              <div class="extra-content">
                <span class="extra-title seguro-title">{{ s.label }}</span>
                <span class="extra-sub">{{ s.description }}</span>
              </div>
              <div class="extra-price">
                <div class="extra-price-main">
                  {{ s.price | currency:'ARS' }}
                </div>
                <div class="extra-price-sub">Por reserva</div>
              </div>
            </label>

            <div class="extra-note">
              Pod√©s continuar sin seguro adicional, pero se aplicar√° la franquicia est√°ndar
              de la sucursal.
            </div>
          </div>
        </section>

        <!-- SEGMENTO NUEVO: adicionales estilo Hertz -->
        <section class="block">
          <div class="block-header">
            <h2>Adicionales</h2>
            <span class="block-tag">Opcionales</span>
          </div>
          <p class="block-subtitle">
            Sum√° servicios y equipamiento para hacer tu viaje m√°s c√≥modo y seguro.
          </p>

          <div class="extras-grid extras-adicionales">
            <div
              class="extra-item extra-adicional"
              *ngFor="let a of adicionales"
            >
              <div class="extra-content">
                <span class="extra-title">{{ a.label }}</span>
                <span class="extra-sub">{{ a.description }}</span>
                <span class="extra-sub extra-sub-price">
                  {{ a.price | currency:'ARS' }}
                  {{ a.billing === 'per_day' ? ' por d√≠a' : ' por reserva' }}
                </span>
              </div>

              <div class="extra-qty">
                <div class="quantity-control">
                  <button
                    type="button"
                    (click)="changeAdicionalCantidad(a.id, -1)"
                    [disabled]="a.quantity === 0"
                  >
                    ‚Äì
                  </button>
                  <span>{{ a.quantity }}</span>
                  <button
                    type="button"
                    (click)="changeAdicionalCantidad(a.id, 1)"
                    [disabled]="a.quantity >= a.maxQuantity"
                  >
                    +
                  </button>
                </div>
                <span class="qty-hint" *ngIf="a.maxQuantity === 1">
                  M√°x. 1
                </span>
              </div>
            </div>
          </div>
        </section>
      </div>
    </article>

    <!-- Panel lateral: resumen de reserva -->
    <aside class="panel panel-resumen">
      <h2>Resumen de tu reserva</h2>

      <div class="resumen-row fechas" *ngIf="startAt && endAt">
        <div>
          <span class="label">Retiro</span>
          <strong>{{ startAt | date:'dd/MM/yyyy' }}</strong>
        </div>
        <div>
          <span class="label">Devoluci√≥n</span>
          <strong>{{ endAt | date:'dd/MM/yyyy' }}</strong>
        </div>
      </div>

      <div class="resumen-row">
        <div>
          <span class="label">Sucursal de retiro</span>
          <strong>#{{ pickupLocationId }}</strong>
        </div>
        <div>
          <span class="label">Cantidad de d√≠as</span>
          <strong>{{ dias }}</strong>
        </div>
      </div>

      <div class="resumen-precio">
        <div class="line">
          <span>Base (tarifa diaria x {{ dias }})</span>
          <span>{{ baseAmount | currency:'ARS' }}</span>
        </div>

        <div class="line">
          <span>Seguro seleccionado</span>
          <span>+ {{ seguroAmount | currency:'ARS' }}</span>
        </div>

        <div class="line">
          <span>Adicionales seleccionados</span>
          <span>+ {{ adicionalesAmount | currency:'ARS' }}</span>
        </div>

        <div class="total-line">
          <span>Total estimado</span>
          <strong>{{ total | currency:'ARS' }}</strong>
        </div>
      </div>

      <p class="nota">
        El precio final puede variar seg√∫n impuestos o cargos locales en la sucursal.
      </p>

      <p *ngIf="errorMsg" class="error-msg">
        {{ errorMsg }}
      </p>

      <button
        class="btn-primary"
        [disabled]="botonDeshabilitado"
        (click)="confirmarReserva()"
      >
        {{ creating ? 'Creando reserva...' : 'Confirmar reserva' }}
      </button>
    </aside>
  </div>
</section>

<!-- Template de carga -->
<ng-template #loadingTpl>
  <div class="loading">
    üöò Cargando informaci√≥n del veh√≠culo...
  </div>
</ng-template>
