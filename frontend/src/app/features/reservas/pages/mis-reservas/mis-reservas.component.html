<div class="reservas-wrapper">
  <h2>Mis reservas</h2>

  <div *ngIf="loading" class="estado">Cargando tus reservas...</div>

  <div *ngIf="!loading && errorMsg" class="estado error">
    {{ errorMsg }}
  </div>

  <div *ngIf="!loading && !errorMsg && reservas.length === 0" class="estado">
    Todavía no tenés reservas.
  </div>

  <div *ngIf="!loading && reservas.length > 0" class="toolbar">
    <span class="toolbar-label">Ordenar por:</span>

    <button class="toolbar-btn" [class.active]="sortField === 'startAt'" (click)="setSort('startAt')">
      Fecha de retiro
      <span *ngIf="sortField === 'startAt'">
        {{ sortDirection === 'asc' ? '↑' : '↓' }}
      </span>
    </button>

    <button class="toolbar-btn" [class.active]="sortField === 'endAt'" (click)="setSort('endAt')">
      Fecha de devolución
      <span *ngIf="sortField === 'endAt'">
        {{ sortDirection === 'asc' ? '↑' : '↓' }}
      </span>
    </button>

    <button class="toolbar-btn" [class.active]="sortField === 'status'" (click)="setSort('status')">
      Estado
      <span *ngIf="sortField === 'status'">
        {{ sortDirection === 'asc' ? '↑' : '↓' }}
      </span>
    </button>
  </div>

  <table *ngIf="!loading && reservas.length > 0" class="tabla-reservas">
    <thead>
      <tr>
        <th>N.º de reserva</th>
        <th>Vehículo</th>
        <th>Retiro</th>
        <th>Devolución</th>
        <th>Desde</th>
        <th>Hasta</th>
        <th>Total</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let r of reservasOrdenadas">
        <td>#{{ r.id }}</td>
        <td>{{ r.vehicleName }}</td>
        <td>{{ r.pickupLocation }}</td>
        <td>{{ r.dropoffLocation }}</td>
        <td>{{ r.startAt | date: 'dd/MM/yyyy' }}</td>
        <td>{{ r.endAt | date: 'dd/MM/yyyy' }}</td>
        <td>{{ r.totalPrice | currency: 'ARS' }}</td>
        <td>
          <span class="badge-estado" [ngClass]="{
              'badge-activa': r.estadoLegible === 'Activa',
              'badge-pendiente': r.estadoLegible === 'Pendiente',
              'badge-finalizada': r.estadoLegible === 'Finalizada',
              'badge-cancelada': r.estadoLegible === 'Cancelada'
            }">
            {{ r.estadoLegible }}
          </span>
        </td>

        <td class="acciones-cell">
          <button type="button" class="btn-link" (click)="verDetalle(r)">
            Ver detalle
          </button>

          <button type="button" class="btn-cancelar" [disabled]="!r.canCancel || cancelandoId === r.id"
            (click)="confirmarCancelacion(r)">
            {{ cancelandoId === r.id ? 'Cancelando...' : 'Cancelar' }}
          </button>

          <!-- ✅ NUEVO: Reportar problema -->
          <button type="button" class="btn-problema" *ngIf="puedeReportarProblema(r.rawStatus)"
            (click)="reportarProblema(r)">
            Reportar problema
          </button>
        </td>
      </tr>
    </tbody>
  </table>
</div>